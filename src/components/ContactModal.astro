---
---

<div id="contact-modal" class="modal hidden">
  <div class="modal-overlay" id="modal-overlay"></div>
  <div class="modal-content">
    <button class="modal-close" id="modal-close" aria-label="Đóng">
      <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
      </svg>
    </button>

    <div class="modal-header">
      <h2 class="text-3xl font-bold text-white mb-2">
        Bắt đầu <span class="text-gradient">miễn phí</span>
      </h2>
      <p class="text-gray-400">
        Điền thông tin để chúng tôi liên hệ với bạn
      </p>
    </div>

    <form id="contact-form" class="modal-form">
      <div class="form-group">
        <label for="contact-name" class="form-label">
          Tên <span class="text-red-400">*</span>
        </label>
        <input
          type="text"
          id="contact-name"
          name="name"
          placeholder="Nhập tên của bạn"
          required
          class="form-input"
        />
      </div>

      <div class="form-group">
        <label for="contact-email" class="form-label">
          Email <span class="text-red-400">*</span>
        </label>
        <input
          type="email"
          id="contact-email"
          name="email"
          placeholder="Nhập email của bạn"
          required
          class="form-input"
        />
      </div>

      <div class="form-group">
        <label for="contact-message" class="form-label">
          Lời nhắn
        </label>
        <textarea
          id="contact-message"
          name="message"
          rows="4"
          placeholder="Nhập lời nhắn của bạn (tùy chọn)"
          class="form-input"
        ></textarea>
      </div>

      <button
        type="submit"
        id="contact-submit-btn"
        class="form-submit"
      >
        <span id="contact-btn-text">Gửi thông tin</span>
        <span id="contact-btn-spinner" class="spinner hidden"></span>
      </button>
    </form>
  </div>
</div>

<!-- Toast Notification -->
<div id="toast" class="toast hidden">
  <div id="toast-message" class="toast-message"></div>
</div>

<style>
  .modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    width: 100vw;
    height: 100vh;
    z-index: 9999;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 1rem;
    margin: 0;
  }

  .modal.hidden {
    display: none;
  }

  .modal-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    backdrop-filter: blur(4px);
    animation: fadeIn 0.2s ease-out;
  }

  .modal-content {
    position: relative;
    background: linear-gradient(135deg, #1f2937 0%, #111827 100%);
    border: 1px solid rgba(139, 92, 246, 0.3);
    border-radius: 1rem;
    padding: 2rem;
    max-width: 500px;
    width: 100%;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5);
    animation: slideUp 0.3s ease-out;
    z-index: 10000;
    margin: auto;
  }

  .modal-close {
    position: absolute;
    top: 1rem;
    right: 1rem;
    background: transparent;
    border: none;
    color: #9ca3af;
    cursor: pointer;
    padding: 0.5rem;
    border-radius: 0.5rem;
    transition: all 0.2s;
    z-index: 10;
  }

  .modal-close:hover {
    color: white;
    background: rgba(255, 255, 255, 0.1);
  }

  .modal-header {
    margin-bottom: 1.5rem;
    text-align: center;
  }

  .modal-form {
    display: flex;
    flex-direction: column;
    gap: 1.25rem;
  }

  .form-group {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .form-label {
    color: #e5e7eb;
    font-weight: 500;
    font-size: 0.875rem;
  }

  .form-input {
    width: 100%;
    padding: 0.75rem 1rem;
    background: #374151;
    border: 1px solid #4b5563;
    border-radius: 0.5rem;
    color: white;
    font-size: 1rem;
    transition: all 0.2s;
  }

  .form-input:focus {
    outline: none;
    border-color: #8b5cf6;
    box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
  }

  .form-input::placeholder {
    color: #9ca3af;
  }

  textarea.form-input {
    resize: vertical;
    min-height: 100px;
  }

  .form-submit {
    width: 100%;
    padding: 0.875rem 1.5rem;
    background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
    color: white;
    border: none;
    border-radius: 0.5rem;
    font-weight: 600;
    font-size: 1rem;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    margin-top: 0.5rem;
  }

  .form-submit:hover:not(:disabled) {
    background: linear-gradient(135deg, #2563eb 0%, #7c3aed 100%);
    transform: translateY(-1px);
    box-shadow: 0 10px 15px -3px rgba(139, 92, 246, 0.3);
  }

  .form-submit:disabled {
    opacity: 0.7;
    cursor: not-allowed;
  }

  .spinner {
    width: 16px;
    height: 16px;
    border: 2px solid rgba(255, 255, 255, 0.3);
    border-top-color: white;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    display: inline-block;
  }

  .spinner.hidden {
    display: none;
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
    }
    to {
      opacity: 1;
    }
  }

  @keyframes slideUp {
    from {
      transform: translateY(20px);
      opacity: 0;
    }
    to {
      transform: translateY(0);
      opacity: 1;
    }
  }

  @keyframes spin {
    to {
      transform: rotate(360deg);
    }
  }

  @media (max-width: 640px) {
    .modal-content {
      padding: 1.5rem;
    }
  }
</style>

<script>
  const modal = document.getElementById('contact-modal');
  const modalOverlay = document.getElementById('modal-overlay');
  const modalClose = document.getElementById('modal-close');
  const contactForm = document.getElementById('contact-form');
  const contactSubmitBtn = document.getElementById('contact-submit-btn');
  const contactBtnText = document.getElementById('contact-btn-text');
  const contactBtnSpinner = document.getElementById('contact-btn-spinner');

  // Hàm mở modal
  function openModal() {
    if (modal) {
      modal.classList.remove('hidden');
      document.body.style.overflow = 'hidden';
    }
  }

  // Hàm đóng modal
  function closeModal() {
    if (modal) {
      modal.classList.add('hidden');
      document.body.style.overflow = '';
      if (contactForm) {
        (contactForm as HTMLFormElement).reset();
      }
    }
  }

  // Đóng modal khi click overlay
  if (modalOverlay) {
    modalOverlay.addEventListener('click', closeModal);
  }

  // Đóng modal khi click nút đóng
  if (modalClose) {
    modalClose.addEventListener('click', closeModal);
  }

  // Đóng modal khi nhấn ESC
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && modal && !modal.classList.contains('hidden')) {
      closeModal();
    }
  });

  // Xử lý form submission
  if (contactForm && contactSubmitBtn) {
    contactForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      const nameInput = document.getElementById('contact-name') as HTMLInputElement;
      const emailInput = document.getElementById('contact-email') as HTMLInputElement;
      const messageInput = document.getElementById('contact-message') as HTMLTextAreaElement;

      if (!nameInput || !emailInput) return;

      const name = nameInput.value.trim();
      const email = emailInput.value.trim();
      const message = messageInput?.value.trim() || '';

      if (!name || !email) return;

      // Hiển thị loading state
      if (contactBtnText) contactBtnText.textContent = 'Đang gửi...';
      if (contactBtnSpinner) contactBtnSpinner.classList.remove('hidden');
      (contactSubmitBtn as HTMLButtonElement).disabled = true;

      // Lấy dữ liệu marketing từ sessionStorage
      let marketingData = {};
      try {
        const storedData = sessionStorage.getItem('rms_marketing_data');
        if (storedData) {
          marketingData = JSON.parse(storedData);
        }
      } catch (e) {
        console.error('Error reading marketing data:', e);
      }

      // Chuẩn bị payload
      const payload = {
        ...marketingData,
        name,
        email,
        message: message + (Object.keys(marketingData).length > 0
          ? `\n\n[Marketing Info]: ${JSON.stringify(marketingData)}`
          : '')
      };

      try {
        // Gửi dữ liệu đến Google Apps Script hoặc API của bạn
        const response = await fetch(
          'https://script.google.com/macros/s/AKfycbwHnsb_JdGIt65kwgnR1E1VzaSHgcPFR5X6cjU1R8rjTA7awfoEPXJh9ueN_LY4yOFZ/exec',
          {
            method: 'POST',
            headers: {
              'Content-Type': 'text/plain',
            },
            body: JSON.stringify(payload),
          }
        );

        if (response.ok) {
          // Reset form và button state
          if (contactBtnText) contactBtnText.textContent = 'Gửi thông tin';
          if (contactBtnSpinner) contactBtnSpinner.classList.add('hidden');
          (contactSubmitBtn as HTMLButtonElement).disabled = false;
          (contactForm as HTMLFormElement).reset();

          // Hiển thị thông báo thành công
          showToast('✅ Gửi thông tin thành công! Chúng tôi sẽ liên hệ với bạn sớm nhất.', 'success');

          // Đóng modal sau 1 giây
          setTimeout(() => {
            closeModal();
          }, 500);
        } else {
          throw new Error('Gửi thông tin thất bại');
        }
      } catch (error) {
        console.error('Error submitting form:', error);
        // Reset button state
        if (contactBtnText) contactBtnText.textContent = 'Gửi thông tin';
        if (contactBtnSpinner) contactBtnSpinner.classList.add('hidden');
        (contactSubmitBtn as HTMLButtonElement).disabled = false;
        showToast('❌ Gửi thông tin thất bại. Vui lòng thử lại sau.', 'error');
      }
    });
  }

  // Hàm hiển thị toast notification
  function showToast(message: string, type: 'success' | 'error') {
    const toast = document.getElementById('toast');
    const toastMessage = document.getElementById('toast-message');

    if (!toast || !toastMessage) {
      console.error('Toast elements not found');
      return;
    }

    toastMessage.textContent = message;
    toast.className = `toast ${type}`;
    toast.classList.remove('hidden', 'hiding');

    // Tự động ẩn sau 4 giây
    setTimeout(() => {
      toast.classList.add('hiding');
      setTimeout(() => {
        toast.classList.add('hidden');
        toast.classList.remove('hiding', 'success', 'error');
      }, 300);
    }, 4000);
  }

  // Export function để các component khác có thể sử dụng
  (window as any).openContactModal = openModal;
</script>

<style>
  /* Toast styles */
  .toast {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 10001;
    min-width: 300px;
    max-width: 500px;
    font-size: 14px;
    pointer-events: none;
  }

  .toast.hidden {
    display: none;
  }

  .toast-message {
    padding: 16px 20px;
    border-radius: 8px;
    font-weight: 500;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    backdrop-filter: blur(10px);
    animation: slideInRight 0.3s ease-out;
  }

  .toast.success .toast-message {
    background: linear-gradient(135deg, rgb(0, 197, 66) 0%, rgb(5, 150, 61) 100%);
    color: white;
  }

  .toast.error .toast-message {
    background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    color: white;
  }

  @keyframes slideInRight {
    from {
      transform: translateX(100%);
      opacity: 0;
    }
    to {
      transform: translateX(0);
      opacity: 1;
    }
  }

  @keyframes slideOutRight {
    from {
      transform: translateX(0);
      opacity: 1;
    }
    to {
      transform: translateX(100%);
      opacity: 0;
    }
  }

  .toast.hiding {
    animation: slideOutRight 0.3s ease-out forwards;
  }

  @media (max-width: 640px) {
    .toast {
      top: 10px;
      right: 10px;
      left: 10px;
      min-width: auto;
      max-width: none;
    }
  }
</style>

